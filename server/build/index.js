/*! For license information please see index.js.LICENSE.txt */
(()=>{"use strict";var e={607:function(e,r,t){var s=this&&this.__createBinding||(Object.create?function(e,r,t,s){void 0===s&&(s=t),Object.defineProperty(e,s,{enumerable:!0,get:function(){return r[t]}})}:function(e,r,t,s){void 0===s&&(s=t),e[s]=r[t]}),o=this&&this.__setModuleDefault||(Object.create?function(e,r){Object.defineProperty(e,"default",{enumerable:!0,value:r})}:function(e,r){e.default=r}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var r={};if(null!=e)for(var t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&s(r,e,t);return o(r,e),r},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});var a=n(t(303)),u=n(t(765)),d=i(t(379)),c=n(t(424)),l=u.default.argv[1],g=a.default(u.default.argv.slice(2),{alias:{assetsDir:"d",loglevel:"l",port:"p",help:"h"},default:{loglevel:"INFO",port:3e3}});!g.help&&g.assetsDir||(console.log(l),console.log("Usage:"),console.log("\t-d\t<assets_dir>\tSet directory path where dynamic assets will be stored"),console.log("\t-l\t<log level>\tSet log level (OFF, FATAL, ERROR, WARN, INFO, DEBUG)"),console.log("\t-p\t<port>\t\t\tSet express port"),console.log("\t-h\t\t\t\tShow this page"),u.default.exit(255)),d.configureLogger({appenders:{stdout:{type:"console"}},categories:{default:{appenders:["stdout"],level:g.loglevel}}});var h=d.default("chat-server");h.info("chat-server version","0.1.0"),h.info("CLI options parsed!"),h.debug("Express port:",g.port),h.debug("Assets dir",g.assetsDir);var f=null,p=function(){h.info("Terminating chat-server..."),f&&(h.debug("Stopping http service..."),f.stop((function(){h.debug("http service stopped!")}))),h.info("chat-server stopped!")};u.default.on("exit",p.bind(null)),u.default.on("SIGINT",p.bind(null)),u.default.on("SIGTERM",p.bind(null)),u.default.on("uncaughtException",(function(e){h.fatal("Uncaught Exception:",e),u.default.abort()})),u.default.on("unhandledRejection",(function(e){h.fatal("Uncaught Rejection:",e),u.default.abort()})),f=new c.default(g.port,g.assetsDir),h.info("chat-server started!")},898:(e,r)=>{Object.defineProperty(r,"__esModule",{value:!0});var t=function(){function e(){this.users=new Array,this.messages=new Array,this.recvSubscriptions=new Array,this.readSubscriptions=new Array}return e.prototype.subscribeReceived=function(e){this.recvSubscriptions.push(e)},e.prototype.subscribeRead=function(e){this.readSubscriptions.push(e)},e.prototype.getUsers=function(e){void 0===e&&(e=void 0);var r=this.users;return void 0!==e&&(r=r.filter((function(r){return r.online===e}))),r},e.prototype.searchUser=function(e){for(var r=0,t=this.users;r<t.length;r++){var s=t[r];if(s.username===e)return s}return null},e.prototype.registerUser=function(e,r,t){if(null!==this.searchUser(e))throw new Error("User already exists");this.users.push({username:e,avatar:r,lastActivity:new Date,online:!0,secret:t})},e.prototype.connectUser=function(e){var r=this.searchUser(e);if(!r)throw new Error("User doesn't exist");r.online=!0,r.lastActivity=new Date},e.prototype.disconnectUser=function(e){var r=this.searchUser(e);if(!r)throw new Error("User doesn't exist");r.online=!1,r.lastActivity=new Date},e.prototype.pushMessage=function(e){var r=this.searchUser(e.from),t=this.searchUser(e.to);if(!r)throw new Error("User '"+e.from+"' doesn't exist");if(!t)throw new Error("User '"+e.to+"' doesn't exist");this.messages.push(e),r.lastActivity=new Date},e.prototype.getConversation=function(e,r){var t=this.searchUser(e);if(!t)throw new Error(e+" doesn't exist");var s=this.searchUser(r);if(!s)throw new Error(r+" doesn't exist");for(var o=[],i=0,n=this.messages;i<n.length;i++){var a=n[i];(a.from===t.username||a.to===s.username||a.from===s.username&&a.to===t.username)&&(a.recv||(a.recv=!0,this.notifyRecvSubscriber(a)),o.push(a))}return o.sort((function(e,r){return r.datetime.getTime()-e.datetime.getTime()})),o},e.prototype.markMessageAsRead=function(e){for(var r=0,t=this.messages;r<t.length;r++){var s=t[r];if(s.id===e)return void(s.read||(s.read=!0,this.notifyReadSubscriber(s)))}throw new Error("Could not find message")},e.prototype.markMessageAsReceived=function(e){for(var r=0,t=this.messages;r<t.length;r++){var s=t[r];if(s.id===e)return void(s.recv||(s.recv=!0,this.notifyRecvSubscriber(s)))}throw new Error("Could not find message")},e.prototype.notifyReadSubscriber=function(e){for(var r=0,t=this.readSubscriptions;r<t.length;r++)(0,t[r])(e)},e.prototype.notifyRecvSubscriber=function(e){for(var r=0,t=this.recvSubscriptions;r<t.length;r++)(0,t[r])(e)},e}();r.default=t},457:(e,r)=>{var t;Object.defineProperty(r,"__esModule",{value:!0}),r.serialize=r.sessionExpired=r.makeRead=r.makeReceived=r.makeError=r.parseMessage=r.WsMessageType=void 0,function(e){e[e.Delivery=0]="Delivery",e[e.Received=1]="Received",e[e.Read=2]="Read",e[e.Error=3]="Error",e[e.SessionExpired=4]="SessionExpired"}(t=r.WsMessageType||(r.WsMessageType={})),r.parseMessage=function(e){var r=t.Error;if(!e.type)throw new Error("Could not find 'type' in payload");switch(e.type){case"Delivery":r=t.Delivery;break;case"Received":r=t.Received;break;case"Read":r=t.Read;break;case"Error":r=t.Error;break;case"SessionExpired":r=t.SessionExpired;break;default:throw new Error("Bad message type")}if(e.message&&r===t.Delivery){var s=e.message;if(!s.id)throw new Error("Missing 'id' in 'message'");if(!s.body)throw new Error("Missing 'body' in 'message'");if(!s.datetime)throw new Error("Missing 'datetime' in 'message'");if(!s.from)throw new Error("Missing 'from' in 'message'");if(!s.to)throw new Error("Missing 'to' in 'message'");return{type:r,message:{id:s.id,body:s.body,datetime:new Date(s.datetime),from:s.from,to:s.to,read:!1,recv:!1}}}if(e.ref&&e.who&&(r===t.Read||r===t.Received))return{type:r,ref:e.ref,who:e.who};if(e.error&&r===t.Error)return{type:r,error:e.error};if(r===t.SessionExpired)return{type:r};throw new Error("Syntax error in message")},r.makeError=function(e){return{type:t.Error,error:e}},r.makeReceived=function(e){return{type:t.Received,ref:e.id,who:e.to}},r.makeRead=function(e){return{type:t.Read,ref:e.id,who:e.to}},r.sessionExpired=function(){return{type:t.SessionExpired}},r.serialize=function(e){var r="";switch(e.type){case t.Delivery:r="Delivery";break;case t.Error:r="Error";break;case t.SessionExpired:r="SessionExpired";break;case t.Read:r="Read";break;case t.Received:r="Received"}return{type:r,who:e.who,ref:e.ref,message:e.message,error:e.error}}},379:function(e,r,t){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.configureLogger=void 0;var o=s(t(455));r.configureLogger=function(e){o.default.configure(e)},r.default=function(e){return o.default.getLogger(e)}},717:(e,r,t)=>{Object.defineProperty(r,"__esModule",{value:!0}),r.sha512=void 0;var s=t(417);r.sha512=function(e){var r=s.createHash("sha512");return r.update(e),r.digest("hex")}},424:function(e,r,t){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});var o=s(t(127)),i=s(t(473)),n=s(t(716)),a=s(t(150)),u=s(t(725)),d=s(t(633)),c=s(t(722)),l=t(717),g=s(t(898)),h=s(t(379)),f=s(t(802)),p=function(){function e(e,r){var t=this;this.logger=h.default("httpService"),this.service=o.default(),this.service.use(i.default.json({limit:"50mb"})),this.service.use(a.default("dev")),this.service.use(u.default()),this.avatarUploadHnd=d.default({dest:r+"/avatar/"});for(var s="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_",c="",l=0;l<32;l++)c+=s.charAt(Math.floor(Math.random()*s.length));this.jwtSecret=c;var p={secret:this.jwtSecret,algorithms:["HS256"],requestProperty:"user"};this.service.use(n.default(p).unless({path:["/api/auth/signUp","/api/auth/signIn"]})),this.store=new g.default,this.server=this.service.listen(e,(function(){t.logger.info("Now listening on port",e)})),this.chat=new f.default(this.store),this.setup()}return e.prototype.stop=function(e){var r=this;void 0===e&&(e=void 0),this.logger.debug("Stopping message service (chat)..."),this.chat.stop((function(){r.logger.debug("Message service stopped!"),r.server.close(),r.logger.info("service stopped!"),e&&e()}))},e.prototype.setup=function(){var e=this;this.service.post("/api/auth/signIn",(function(r,t){if("username"in r.body&&"secret"in r.body){var s=r.body.username,o=l.sha512(r.body.secret),i=e.store.searchUser(s);if(i)if(o===i.secret){e.logger.debug("User",s,"signed in!");var n=c.default.sign({username:s},e.jwtSecret,{algorithm:"HS256"});t.send({jwt:n}),e.store.connectUser(s)}else e.logger.debug("Tried to authenticate with username",s,"but password is wrong"),t.sendStatus(401);else e.logger.debug("Tried to authenticate with username",s,"but doesn't exist"),t.sendStatus(401)}else t.sendStatus(400)})),this.service.post("/api/auth/signUp",this.avatarUploadHnd.single("avatar"),(function(r,t){if(r.body.username&&r.body.secret){var s=r.body.username,o=l.sha512(r.body.password);if(e.store.searchUser(s))e.logger.debug("Tried to register already existing user:",s),t.sendStatus(409);else{var i=r.file?r.file.destination:null;try{e.store.registerUser(s,i,o),e.logger.info("Registered new user",s);var n=c.default.sign({username:s},e.jwtSecret,{algorithm:"HS256"});t.send({jwt:n}),e.store.connectUser(s)}catch(r){e.logger.error("Could not register user:",r),t.sendStatus(500)}}}else t.sendStatus(400)})),this.service.post("/api/auth/signOut",(function(r,t){e.logger.debug("User signed out"),t.sendStatus(200)})),this.service.get("/api/chat/users",(function(r,t){for(var s=e.store.getUsers(),o=new Array,i=0,n=s;i<n.length;i++){var a=n[i];o.push({username:a.username,avatar:a.avatar,lastActivity:a.lastActivity.toISOString(),online:a.online})}t.send(o)})),this.service.get("/api/chat/history/:username",(function(r,t){var s=r.user.username,o=r.params.username;if(o)try{var i=e.store.getConversation(s,o);t.send(i)}catch(r){e.logger.error("Could not fetch history for",s,"and",o,r),t.sendStatus(500)}else t.sendStatus(400)})),this.service.post("/api/chat/setread/:id",(function(r,t){var s=r.params.id;if(s)try{e.store.markMessageAsRead(s),e.logger.debug("Marked message",s,"as read"),t.sendStatus(200)}catch(r){e.logger.error("Could not set message",s,"as read",r),t.sendStatus(500)}else t.sendStatus(400)})),this.server.on("upgrade",(function(r,t,s){var o=r.user.username;e.logger.debug(o,"has started a websockets session"),e.chat.accept(r,t,s,o)}))},e}();r.default=p},802:function(e,r,t){var s=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0});var o=s(t(439)),i=s(t(379)),n=t(457),a=function(){function e(e){var r=this;this.channels=new Map,this.store=e,this.store.subscribeRead((function(e){r.dispatchRead(e)})),this.store.subscribeReceived((function(e){r.dispatchReceived(e)})),this.logger=i.default("messageService"),this.wsServer=new o.default.Server({noServer:!0}),this.wsServer.on("connection",(function(e,t,s){r.logger.info("New websockets connection from",s),r.channels.set(s,e),e.on("message",(function(t){r.dispatchMessage(s,e,t)})),e.on("close",(function(){r.logger.info("Client",s,"has left chat!"),e.close(),r.channels.delete(s)}))}))}return e.prototype.stop=function(e){void 0===e&&(e=void 0),this.logger.info("Stopping message service..."),this.wsServer.close(),this.channels.clear(),this.logger.info("Message service stopped!"),e&&e()},e.prototype.accept=function(e,r,t,s){var o=this;this.logger.debug("Handling upgrade for",s),this.wsServer.handleUpgrade(e,r,t,(function(r){o.wsServer.emit("connection",r,e,s),o.logger.debug("Emitted connection event for",s)}))},e.prototype.dispatchMessage=function(e,r,t){var s;try{var o=JSON.parse(t.toString());s=n.parseMessage(o),this.logger.debug("Got WS message (",s.type,") from",e,"with type",s.type)}catch(e){return void this.logger.error("Could not parse ws message:",e)}switch(s.type){case n.WsMessageType.Delivery:s.message&&this.dispatchDelivery(r,s.message);break;case n.WsMessageType.Error:this.logger.warn("Client",e,"reports error:",s.error);break;default:this.logger.debug("Got nothing to do with message",s.type)}},e.prototype.dispatchDelivery=function(e,r){var t=this,s=function(e){t.logger.error("Could not send message:",e)},o=this.store.searchUser(r.from);if(o){var i=this.store.searchUser(r.to);if(i)if(i!==o){try{this.store.pushMessage(r),this.logger.debug("Saved message to store!")}catch(r){return this.logger.error("Could not save message to store:",r),d=n.serialize(n.makeError("Could not save message to store:"+r)),void e.send(d,s)}var a=this.channels.get(r.to);if(a){var u={type:n.WsMessageType.Delivery,message:r};this.logger.debug("Sending message to",r.to),a.send(n.serialize(u),s),this.logger.info("Message dispatched to",r.to)}else this.logger.warn("Recipient socket doesn't exist (but user does), probably he's offline")}else this.logger.error("Message has same recipient and sender!"),d=n.serialize(n.makeError("Message has same recipient and sender!")),e.send(d,s);else{this.logger.error("User",r.to,"doesn't exist!");var d=n.serialize(n.makeError("User '"+r.to+"' doesn't exist!"));e.send(d,s)}}else{this.logger.error("Sender",r.from,"doesn't exist!? Has its session expired?");d=n.serialize(n.sessionExpired());e.send(d,s)}},e.prototype.dispatchRead=function(e){var r=this,t=this.channels.get(e.from);if(t){var s=n.makeRead(e);this.logger.debug("Sending read notification for",s.ref,"with recipient",s.who,"to",e.to),t.send(n.serialize(s),(function(e){r.logger.error("Could not send message:",e)})),this.logger.info("Read notification dispatched to",e.to)}else this.logger.debug("No socket is available for",e.from,", is it offline?")},e.prototype.dispatchReceived=function(e){var r=this,t=this.channels.get(e.from);if(t){var s=n.makeReceived(e);this.logger.debug("Sending received notification for",s.ref,"with recipient",s.who,"to",e.to),t.send(n.serialize(s),(function(e){r.logger.error("Could not send message:",e)})),this.logger.info("Received notification dispatched to",e.to)}else this.logger.debug("No socket is available for",e.from,", is it offline?")},e}();r.default=a},473:e=>{e.exports=require("body-parser")},417:e=>{e.exports=require("crypto")},127:e=>{e.exports=require("express")},716:e=>{e.exports=require("express-jwt")},303:e=>{e.exports=require("getopts")},725:e=>{e.exports=require("helmet")},722:e=>{e.exports=require("jsonwebtoken")},455:e=>{e.exports=require("log4js")},150:e=>{e.exports=require("morgan")},633:e=>{e.exports=require("multer")},765:e=>{e.exports=require("process")},439:e=>{e.exports=require("ws")}},r={};!function t(s){if(r[s])return r[s].exports;var o=r[s]={exports:{}};return e[s].call(o.exports,o,o.exports,t),o.exports}(607)})();